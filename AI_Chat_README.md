# STM32 AI聊天功能说明

## 功能概述

本功能为STM32智能控制系统增加了AI问答能力，通过蓝牙接收问题，调用DeepSeek API获取答案，并在LCD屏幕上显示。

## 系统架构

```
手机蓝牙 → HC05模块 → STM32 → 电脑 → DeepSeek API
                      ↓        ↓
                    LCD显示 ← 答案返回
```

## 使用准备

### 1. 硬件要求
- STM32开发板（已配置HC05蓝牙模块）
- TFT LCD显示屏
- USB转串口模块（连接电脑）
- 支持蓝牙的手机

### 2. 软件要求
- Python 3.6+ 
- 必需库：`pip install pyserial requests`
- DeepSeek API密钥（从 https://platform.deepseek.com 获取）

### 3. 串口连接
- STM32 USART1 (PA9/PA10) ↔ 电脑USB串口
- STM32 USART3 (PB10/PB11) ↔ HC05蓝牙模块

## 使用步骤

### 第一步：启动Python桥接程序
```bash
python ai_chat_bridge.py
```
根据提示输入：
- 串口号（如COM3、/dev/ttyUSB0）
- DeepSeek API密钥

### 第二步：STM32操作
1. 给STM32开发板上电
2. 按KEY2切换到蓝牙模式
3. 等待HC05蓝牙模块初始化完成

### 第三步：手机连接
1. 打开手机蓝牙，搜索"HC-05"设备
2. 配对连接（密码通常是1234或0000）
3. 使用蓝牙串口调试APP连接

### 第四步：发送问题
在手机APP中发送包含问号的问题，例如：
- "今天天气怎么样？"
- "北京有什么好玩的地方?"
- "如何学习编程？"

### 第五步：查看答案
- LCD屏幕会显示"AI thinking..."
- 几秒后显示AI回答
- 如答案较长，按KEY1向下滚动

## 操作说明

### 蓝牙模式按键功能
- **KEY1**: 
  - 问答模式：滚动查看长答案
  - 普通模式：开启/停止数据发送
- **KEY2**: 切换回传感器模式
- **KEY_UP**: 切换蓝牙主从模式

### 问题格式
支持以下格式的问题：
- 包含"?"或"？"的自然语言问题
- 以"+ASK:"开头的命令格式
- 任何以问号结尾的文本

### 屏幕显示
- **Q:** 显示接收到的问题
- **A:** 显示AI回答
- **AI thinking...** 表示正在处理
- **KEY1: Scroll down** 表示可以滚动

## 故障排除

### 常见问题

1. **串口连接失败**
   - 检查串口号是否正确
   - 确认STM32已连接并上电
   - Windows下确认设备管理器中的COM口

2. **蓝牙连接失败**
   - 确认HC05模块电源和连线
   - 重新搜索并配对蓝牙设备
   - 检查配对密码

3. **API调用失败**
   - 确认API密钥正确
   - 检查网络连接
   - 确认DeepSeek API额度

4. **无回答显示**
   - 检查Python程序是否运行
   - 确认问题包含问号
   - 查看Python程序控制台输出

### 调试方法

1. **串口调试**
   ```bash
   # 查看STM32发送的数据
   +QUESTION:今天天气怎么样？
   ```

2. **Python程序日志**
   ```
   接收到数据: +QUESTION:今天天气怎么样？
   提取到问题: 今天天气怎么样？
   正在调用AI API...
   AI回答: 今天天气晴朗，适合出行...
   答案已发送: 今天天气晴朗，适合出行...
   ```

## 技术细节

### 通信协议
- **STM32→电脑**: `+QUESTION:问题内容\r\n`
- **电脑→STM32**: `+ANSWER:答案内容\r\n`

### API参数配置
- 模型：deepseek-chat
- 最大tokens：200
- 温度：0.7
- 超时：30秒

### 缓冲区大小
- 问题缓冲区：200字符
- 答案缓冲区：500字符
- 显示区域：4行×27字符

## 扩展功能

可以考虑添加的功能：
- 语音识别输入
- 多轮对话记忆
- 自定义AI提示词
- 离线问答缓存
- 多语言支持

## 注意事项

1. **API费用**: DeepSeek API按使用量计费，请控制使用频率
2. **网络要求**: 需要稳定的网络连接访问API
3. **功耗考虑**: 蓝牙和WiFi会增加功耗
4. **安全提醒**: 请勿发送敏感信息

## 联系支持

如遇问题，请检查：
- 硬件连接是否正确
- 软件配置是否完整
- 网络和API是否正常
- 错误日志和状态信息 